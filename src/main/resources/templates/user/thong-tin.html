<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org" lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Thông tin cá nhân</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.0/font/bootstrap-icons.css" rel="stylesheet">
    <link th:href="@{/layout/style.css}" rel="stylesheet">

    <style>
        .card-info .info-row {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: .75rem 1rem;
            border-bottom: 1px solid #e9ecef;
            gap: 1rem;
        }

        .card-info .info-row:last-of-type {
            border-bottom: none;
        }

        /* label/value responsive flex rules */
        .card-info .info-label {
            font-weight: 600;
            color: #495057;
            flex: 0 0 40%;
        }

        .card-info .info-value {
            color: #212529;
            flex: 1 1 auto;
            text-align: right;
            word-break: break-word;
        }

        .card-info .info-value.text-muted {
            color: #6c757d;
        }

        /* actions spacing so borders don't butt up against buttons */
        .card-info .actions {
            margin-top: .75rem;
        }
    </style>

    <meta name="_csrf" th:content="${_csrf.token}"/>
    <meta name="_csrf_header" th:content="${_csrf.headerName}"/>
</head>
<body>
<!-- HEADER -->
<div th:replace="~{fragments/header :: header}"></div>

<div class="container-fluid">
    <div class="row">
        <!-- SIDEBAR -->
        <nav class="col-md-3 col-lg-2 d-md-block bg-light sidebar">
            <div th:replace="~{fragments/sidebar-user :: sidebar-user}"></div>
        </nav>

        <!-- NỘI DUNG CHÍNH -->
        <main class="col-md-9 ms-sm-auto col-lg-10 px-md-4 py-4">
            <div class="d-flex justify-content-between flex-wrap flex-md-nowrap align-items-center pb-2 mb-3 border-bottom">
                <h1 class="h2"><i class="bi bi-person-circle"></i> Thông tin cá nhân</h1>
            </div>

            <!-- Card thông tin -->
            <div class="card shadow-sm card-info">
                <div class="card-header bg-primary text-white">
                    <h5 class="mb-0"><i class="bi bi-person-badge me-2"></i>Thông tin tài khoản</h5>
                </div>
                <div class="card-body">
                    <!-- Display user info with clean divider lines -->
                    <div class="info-row">
                        <div class="info-label">Email</div>
                        <div class="info-value text-muted" th:text="${userForm.email}"></div>
                    </div>

                    <div class="info-row">
                        <div class="info-label">Họ và tên</div>
                        <div class="info-value" th:text="${userForm.username}"></div>
                    </div>

                    <div class="info-row">
                        <div class="info-label">Số điện thoại</div>
                        <div class="info-value" th:text="${userForm.phoneNumber}"></div>
                    </div>

                    <div class="info-row">
                        <div class="info-label">Số CCCD/CMND</div>
                        <div class="info-value" th:text="${userForm.citizenIdNumber}"></div>
                    </div>

                    <div class="actions d-flex justify-content-end gap-2">
                        <a th:href="@{/user/bang-dieu-khien}" class="btn btn-secondary">
                            <i class="bi bi-x-circle me-1"></i>Hủy
                        </a>
                        <!--                        nút edit-->
                        <button type="button" class="btn btn-sm btn-outline-info me-1" data-bs-toggle="modal"
                                data-bs-target="#userModal">
                            <i class="bi bi-pencil"></i> Chỉnh sửa
                        </button>
                    </div>
                </div>
            </div>

            <!-- Thông tin bổ sung -->
        </main>
    </div>
</div>

<!-- FOOTER -->
<div th:replace="~{fragments/footer :: footer}"></div>

<!-- User Edit Modal (similar to admin) -->
<div class="modal fade" id="userModal" tabindex="-1" aria-labelledby="userModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <form th:action="@{/user/update}" th:object="${userForm}" method="post" id="userEditForm">
                <div class="modal-header">
                    <h5 class="modal-title" id="userModalLabel">Chỉnh sửa thông tin</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <input type="hidden" th:field="*{id}"/>

                    <div th:if="${_csrf != null}">
                        <input type="hidden" th:name="${_csrf.parameterName}" th:value="${_csrf.token}"/>
                    </div>

                    <div class="mb-3">
                        <label for="modalEmail">Tài khoản (Email)</label>
                        <input type="email" id="modalEmail" class="form-control" th:field="*{email}" readonly/>
                    </div>
                    <div class="mb-3">
                        <label for="modalCurrentPassword">Mật khẩu cũ</label>
                        <input type="password" id="modalCurrentPassword" name="currentPassword" class="form-control"
                               placeholder="Nhập mật khẩu hiện tại để đổi"/>
                    </div>
                    <div class="mb-3">
                        <label for="modalNewPassword">Mật khẩu mới</label>
                        <input type="password" id="modalNewPassword" name="password" class="form-control"
                               placeholder="Nhập mật khẩu mới (tối thiểu 6 ký tự)"/>
                    </div>
                    <div class="mb-3">
                        <label for="modalConfirmPassword">Xác nhận mật khẩu mới</label>
                        <input type="password" id="modalConfirmPassword" name="confirmPassword" class="form-control"
                               placeholder="Nhập lại mật khẩu mới"/>
                    </div>
                    <div class="mb-3">
                        <label for="modalUsername">Họ và tên</label>
                        <input type="text" id="modalUsername" class="form-control" th:field="*{username}" required/>
                    </div>
                    <div class="mb-3">
                        <label for="modalPhoneNumber">Số điện thoại</label>
                        <input type="text" id="modalPhoneNumber" class="form-control" th:field="*{phoneNumber}"/>
                    </div>
                    <div class="mb-3">
                        <label for="modalCitizenIdNumber">Số CCCD/CMND</label>
                        <input type="text" id="modalCitizenIdNumber" class="form-control"
                               th:field="*{citizenIdNumber}"/>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Đóng</button>
                    <button type="submit" class="btn btn-primary" id="btnSaveUser">Lưu</button>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- JS -->
<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
<script src="https://cdn.jsdelivr.net/npm/@popperjs/core@2.11.8/dist/umd/popper.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.min.js"></script>
<script>
    // Xóa trạng thái lỗi/đánh dấu (is-invalid) khỏi các trường input
    // Mục đích: được gọi trước khi bắt đầu validate lại hoặc gửi form để xóa các highlight cũ
    function clearFieldError() {
        $('.is-invalid').removeClass('is-invalid');
    }

    // Đánh dấu một trường là lỗi và focus tới trường đó
    // Mục đích: sử dụng để thông báo cho người dùng biết trường nào bị sai (ví dụ mật khẩu không khớp)
    function markFieldError(fieldSelector) {
        try {
            $(fieldSelector).addClass('is-invalid').focus();
        } catch (e) {
        }
    }

    (function () {
        // IIFE: gói toàn bộ logic liên quan tới form modal chỉnh sửa thông tin người dùng
        // Mục đích: tách scope, tránh ô nhiễm biến toàn cục và khởi tạo event handler cho form
        const $form = $("#userEditForm");
        const $btnSave = $('#btnSaveUser');

        // Bắt sự kiện submit cho form chỉnh sửa
        // Luồng chính:
        // 1) ngăn form submit mặc định
        // 2) xóa highlight lỗi cũ
        // 3) validate client-side (chỉ kiểm tra password khi user nhập mật khẩu cũ)
        // 4) chuẩn bị payload và gửi AJAX tới endpoint '/user/update-ajax'
        // 5) xử lý response: hiển thị thông báo (SweetAlert), cập nhật các trường hiển thị trên trang, đóng modal khi thành công
        $form.on('submit', function (e) {
            e.preventDefault();
            clearFieldError();

            // Đọc giá trị từ các trường modal
            const currentPass = $('#modalCurrentPassword').val();
            const newPass = $('#modalNewPassword').val();
            const confirmPass = $('#modalConfirmPassword').val();
            const username = $('#modalUsername').val();
            const phoneNumber = $('#modalPhoneNumber').val();
            const citizenIdNumber = $('#modalCitizenIdNumber').val();

            // VALIDATION CLIENT-SIDE
            // Mục đích: giảm tải cho server và cung cấp phản hồi nhanh cho người dùng
            // Chỉ thực hiện kiểm tra mật khẩu mới nếu người dùng đã nhập mật khẩu hiện tại
            if (currentPass && currentPass.trim() !== '') {
                if (!newPass || newPass.trim() === '') {
                    Swal.fire({icon: 'warning', title: 'Thiếu thông tin', text: 'Vui lòng nhập mật khẩu mới.'});
                    markFieldError('#modalNewPassword');
                    return;
                }
                if (newPass.trim().length < 6) {
                    Swal.fire({
                        icon: 'warning',
                        title: 'Mật khẩu ngắn',
                        text: 'Mật khẩu mới phải có tối thiểu 6 ký tự.'
                    });
                    markFieldError('#modalNewPassword');
                    return;
                }
                if (newPass !== confirmPass) {
                    Swal.fire({icon: 'warning', title: 'Không khớp', text: 'Xác nhận mật khẩu mới không khớp.'});
                    markFieldError('#modalConfirmPassword');
                    return;
                }
            }

            // Chuẩn bị payload gửi lên server
            const payload = {
                username: username,
                phoneNumber: phoneNumber,
                citizenIdNumber: citizenIdNumber,
                password: newPass || '',
                currentPassword: currentPass || '',
                confirmPassword: confirmPass || ''
            };
            // Lấy CSRF token và header từ meta tags (cần cho Spring Security)
            const csrfToken = $('meta[name="_csrf"]').attr('content');
            const csrfHeader = $('meta[name="_csrf_header"]').attr('content');

            $btnSave.prop('disabled', true);

            // Gửi AJAX (POST) tới endpoint xử lý cập nhật người dùng
            // Mục đích: cập nhật thông tin mà không reload trang
            $.ajax({
                url: '/user/update-ajax',
                method: 'POST',
                dataType: 'json',
                contentType: 'application/x-www-form-urlencoded; charset=UTF-8',
                data: payload,
                beforeSend: function (xhr) {
                    if (csrfHeader && csrfToken) {
                        xhr.setRequestHeader(csrfHeader, csrfToken);
                    }
                    // mark request as AJAX so Spring Security can return 401/unauthorized instead of redirecting
                    try {
                        xhr.setRequestHeader('X-Requested-With', 'XMLHttpRequest');
                    } catch (e) {
                    }
                }
            }).done(function (resp) {
                // Xử lý khi server trả về thành công
                // Mục đích: thông báo cho người dùng, cập nhật hiển thị trên trang và đóng modal
                if (resp && resp.ok) {
                    Swal.fire({
                        icon: 'success',
                        title: 'Thành công',
                        text: resp.msg || 'Đã cập nhật'
                    }).then(function () {
                        // Cập nhật các trường hiển thị trên trang (tên, điện thoại, CCCD)
                        var $modalUsername = $('#modalUsername');
                        var updatedUsername = resp.username || $modalUsername.val();
                        $modalUsername.val(updatedUsername);
                        $('.card-info .info-row:contains("Họ và tên") .info-value').text(resp.username || '');
                        $('.card-info .info-row:contains("Số điện thoại") .info-value').text(resp.phoneNumber || '');
                        $('.card-info .info-row:contains("Số CCCD/CMND") .info-value').text(resp.citizenIdNumber || '');
                        // Đóng modal dùng API chính thức của Bootstrap 5
                        (function () {
                            var modalEl = document.getElementById('userModal');
                            if (modalEl) {
                                var modalInstance = bootstrap.Modal.getInstance(modalEl);
                                if (!modalInstance) modalInstance = new bootstrap.Modal(modalEl);
                                modalInstance.hide();
                            }
                        })();
                    });
                } else {
                    // Xử lý lỗi trả về từ server (ví dụ validate phía server thất bại)
                    var msg = (resp && resp.msg) ? resp.msg : 'Có lỗi xảy ra';
                    Swal.fire({icon: 'error', title: 'Lỗi', text: msg});
                    if (resp && resp.field) {
                        if (resp.field === 'currentPassword') markFieldError('#modalCurrentPassword');
                        if (resp.field === 'password') markFieldError('#modalNewPassword');
                        if (resp.field === 'confirmPassword') markFieldError('#modalConfirmPassword');
                        if (resp.field === 'citizenIdNumber') markFieldError('#modalCitizenIdNumber');
                    }
                }
            }).fail(function (xhr, status, errorThrown) {
                // Xử lý khi không thể kết nối hoặc lỗi mạng
                console.error('AJAX /user/update-ajax failed', {
                    status: xhr.status,
                    statusText: xhr.statusText,
                    responseText: xhr.responseText,
                    error: errorThrown
                });
                var text = 'Có lỗi khi kết nối đến server';
                try {
                    if (xhr.responseJSON && xhr.responseJSON.msg) text = xhr.responseJSON.msg;
                    else if (xhr.responseText) {
                        try {
                            var parsed = JSON.parse(xhr.responseText);
                            if (parsed && parsed.msg) text = parsed.msg;
                        } catch (e) {
                            text = xhr.responseText;
                        }
                    }
                } catch (e) {
                }
                var title = 'Lỗi';
                if (xhr.status && xhr.status !== 0) title += ' (' + xhr.status + ')';
                var lower = ('' + text).toLowerCase();
                if (lower.indexOf('<!doctype html') !== -1 || lower.indexOf('<html') !== -1 || lower.indexOf('đăng nhập') !== -1 || xhr.status === 302) {
                    Swal.fire({
                        icon: 'warning',
                        title: 'Phiên đã hết',
                        text: 'Phiên làm việc của bạn có thể đã hết — vui lòng đăng nhập lại.'
                    });
                } else {
                    Swal.fire({icon: 'error', title: title, text: text});
                }
            }).always(function () {
                // Luôn bật lại nút Lưu sau khi AJAX hoàn tất
                $btnSave.prop('disabled', false);
            });
        });

        // Khi user gõ vào các trường liên quan đến mật khẩu/CCCD, bỏ highlight lỗi
        $('#modalCurrentPassword, #modalNewPassword, #modalConfirmPassword, #modalCitizenIdNumber').on('input', function () {
            $(this).removeClass('is-invalid');
        });

        // Khi modal đóng, chỉ clear các trường mật khẩu (không chạm đến các trường khác)
        // Mục đích: tránh để lại mật khẩu cũ/new trong input khi modal bị đóng
        var userModalEl = document.getElementById('userModal');
        if (userModalEl) {
            userModalEl.addEventListener('hidden.bs.modal', function () {
                try {
                    $('#modalCurrentPassword, #modalNewPassword, #modalConfirmPassword')
                        .val('')
                        .removeClass('is-invalid');
                } catch (e) {
                }
            });
        }
    })();
</script>
</body>
</html>
